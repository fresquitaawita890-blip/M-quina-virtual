name: PC_GAMER_FINAL_V10
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 1_Configurar_RDP_y_Usuario
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          net user RDP RobloxVM2026 /add
          net localgroup Administrators RDP /add
          
      - name: 2_Instalar_Graficos_Mesa3D_Seguro
        run: |
          # Instalamos Mesa3D usando el gestor oficial de Windows (Chocolatey) de forma directa
          choco install mesa3d-softpipe -y
          # Esto pone los graficos en el sistema sin necesidad de andar moviendo archivos manualmente
          
      - name: 3_Preparar_Roblox
        run: |
          # Descargamos el instalador directo al escritorio del usuario RDP
          $url = "https://setup.rbxcdn.com/RobloxPlayerLauncher.exe"
          $dest = "C:\Users\RDP\Desktop\Instalar_Roblox.exe"
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          Invoke-WebRequest -Uri $url -OutFile $dest
          
      - name: 4_Conectar_Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile "ts.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "ts.msi", "/quiet", "/norestart" -Wait
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-pc-gamer
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          Write-Host "=============================="
          Write-Host "TU IP ES: $tsIP"
          Write-Host "=============================="
          
      - name: 5_Mantener_Viva
        run: Start-Sleep -Seconds 21600
        
